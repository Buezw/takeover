<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æš—è‰²é£æ ¼æ—¥å†ç¤ºä¾‹</title>
  <style>
    /* ---------------------- å…¨å±€æ ·å¼ ---------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #1e1e1e; /* æ·±è‰²èƒŒæ™¯ */
      color: #ffffff; /* ç™½è‰²æ–‡å­— */
      display: flex;
      height: 100vh;
      overflow: hidden; /* é˜²æ­¢å‡ºç°æ»šåŠ¨æ¡ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ */
    }

    /* ---------------------- å·¦ä¾§æ æ ·å¼ ---------------------- */
    .sidebar {
      width: 300px; /* ä»250pxå¢åŠ åˆ°300pxï¼Œä½¿è¾¹æ æ›´å®½ */
      background-color: #2b2b2b;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100vh; /* ç¡®ä¿å æ»¡æ•´ä¸ªé«˜åº¦ */
    }
    .sidebar h2 {
      font-size: 16px;
      margin-bottom: 20px;
    }
    .sidebar .calendar-list {
      list-style: none;
      padding-left: 0;
      margin-bottom: 20px; /* æ·»åŠ åº•éƒ¨é—´è· */
    }
    .sidebar .calendar-list li {
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.2s;
      padding: 8px 12px;
      border-radius: 4px;
    }
    .sidebar .calendar-list li:hover {
      background-color: #3a3a3a;
    }

    /* ä¾§æ ä¸­çš„AIèŠå¤©æ ·å¼ */
    .sidebar-chat {
      margin-top: auto; /* è®©èŠå¤©åŒºåŸŸé è¿‘åº•éƒ¨ */
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 200px; /* æœ€å°é«˜åº¦ */
    }

    .chat-header {
      padding: 10px 0;
      margin-bottom: 10px;
      border-top: 1px solid #3a3a3a;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-right: 5px;
      margin-bottom: 10px;
      max-height: 300px; /* æœ€å¤§é«˜åº¦ */
    }

    .message {
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 100%;
      font-size: 13px;
      line-height: 1.4;
    }

    .user-message {
      background-color: #4285f4;
      align-self: flex-end;
    }
    
    .ai-message {
      background-color: #3a3a3a;
      align-self: flex-start;
    }

    .sidebar-chat-input {
      display: flex;
      gap: 8px;
    }

    .ai-chat-input {
      flex: 1;
      background-color: #3a3a3a;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      color: #ffffff;
      font-size: 14px;
    }

    .ai-chat-input:focus {
      outline: none;
      background-color: #404040;
    }

    .ai-chat-button {
      background-color: #4285f4;
      border: none;
      border-radius: 4px;
      padding: 8px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .ai-chat-button:hover {
      background-color: #3367d6;
    }

    /* ---------------------- ä¸»ä½“åŒºåŸŸæ ·å¼ ---------------------- */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      height: 100vh; /* è®¾ç½®ä¸ºè§†çª—é«˜åº¦ */
      box-sizing: border-box;
    }

    /* æ—¥å†å®¹å™¨æ ·å¼ - ç§»é™¤å¯¹è¯æ¡†åè°ƒæ•´é«˜åº¦ */
    .calendar-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%; /* å æ®æ‰€æœ‰å¯ç”¨ç©ºé—´ */
    }

    /* ---------------------- æ—¥å†è¡¨æ ¼æ ·å¼ ---------------------- */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px; /* ç½‘æ ¼ä¹‹é—´çš„ç»†åˆ†å‰²çº¿ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ */
      background-color: #3a3a3a;
    }

    #calendarHeader {
      margin-bottom: 1px;
    }

    #calendarGrid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(6, 1fr);
      min-height: 0; /* ç§»é™¤æœ€å°é«˜åº¦é™åˆ¶ */
    }

    /* æ¯ä¸ªæ—¥æœŸå•å…ƒæ ¼ */
    .day-cell {
      background-color: #2b2b2b;
      padding: 10px;
      display: flex;
      flex-direction: column;
      position: relative;
      height: 100%; /* ç¡®ä¿å•å…ƒæ ¼å¡«å……æ•´ä¸ªç½‘æ ¼åŒºåŸŸ */
      box-sizing: border-box;
    }
    .day-cell:hover {
      background-color: #3d3d3d;
    }
    /* æ—¥æœŸæ•°å­— */
    .day-number {
      font-size: 14px;
      margin-bottom: 8px;
      color: #fff;
    }
    /* ä¸åœ¨æœ¬æœˆçš„æ—¥æœŸï¼Œç°è‰²æ˜¾ç¤º */
    .not-current-month {
      color: #666;
    }
    /* æ˜ŸæœŸè¡Œæ ‡é¢˜ */
    .weekday-header {
      background-color: #2b2b2b;
      text-align: center;
      font-weight: bold;
      padding: 8px 0;
    }

    /* æ·»åŠ äº‹ä»¶æ ‡è®°æ ·å¼ */
    .event-markers {
      margin-top: 5px;
    }
    .event-marker {
      font-size: 10px;
      color: #4285f4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ---------------------- å³ä¾§æ æ ·å¼ ---------------------- */
    .right-sidebar {
      width: 300px;
      background-color: #2b2b2b;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .right-sidebar .date-info {
      margin-bottom: 20px;
    }
    .right-sidebar .date-info h2 {
      margin: 0;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .right-sidebar .date-info p {
      margin: 0;
      font-size: 14px;
      color: #bbb;
    }
    .right-sidebar .event-info {
      font-size: 14px;
      color: #bbb;
    }
    .right-sidebar .event-info .no-event {
      margin-top: 20px;
    }

    /* ä¸»ä½“å¤´éƒ¨æ ·å¼ä¿®æ”¹ */
    .main-header {
      display: flex;
      align-items: center;
      justify-content: flex-start; /* æ”¹ä¸ºå·¦å¯¹é½ */
      margin-bottom: 20px;
      gap: 20px; /* æ·»åŠ é—´è· */
    }
    .main-header .left-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .main-header button {
      background-color: #3a3a3a;
      border: none;
      color: #ffffff;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      height: 32px; /* ç»Ÿä¸€æŒ‰é’®é«˜åº¦ */
      line-height: 20px; /* ç¡®ä¿æ–‡å­—å‚ç›´å±…ä¸­ */
    }
    .main-header h1 {
      font-size: 18px;
      margin: 0;
      line-height: 32px; /* ä¸æŒ‰é’®é«˜åº¦ä¸€è‡´ */
    }

    /* è°ƒè¯•çª—å£æ ·å¼ */
    .debug-window {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 300px;
        background-color: #2b2b2b;
        border: 1px solid #4285f4;
        border-radius: 8px;
        padding: 15px;
        z-index: 1000;
        display: none;
    }
    
    .debug-window.show {
        display: block;
    }
    
    .debug-window pre {
        color: #4285f4;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .debug-window .close-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        cursor: pointer;
        color: #888;
    }
  </style>
</head>
<body>

  <!-- å·¦ä¾§æ  - æ·»åŠ èŠå¤©åŠŸèƒ½ -->
  <div class="sidebar">
    <h2>æ·»åŠ æ—¥å†</h2>
    <ul class="calendar-list">
      <li>yingan.huang@gmail.com</li>
      <li>Calendar</li>
      <li>buzewwg@outlook.com</li>
      <li>El5f</li>
      <li>El5f</li>
      <li>jeffry.huang@2020eq...</li>
    </ul>
    
    <!-- AIèŠå¤©åŒºåŸŸ -->
    <div class="sidebar-chat">
      <div class="chat-header">
        <span>AI åŠ©æ‰‹</span>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message ai-message">
          æ‚¨å¥½ï¼æˆ‘æ˜¯æ—¥å†åŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨ï¼š<br>
          - æ·»åŠ æ˜å¤©ä¸‹åˆ3ç‚¹çš„å›¢é˜Ÿä¼šè®®<br>
          - åˆ›å»ºä¸‹å‘¨ä¸€ä¸Šåˆ10ç‚¹çš„é¡¹ç›®è¯„å®¡<br>
          - å®‰æ’2024å¹´1æœˆ20æ—¥å…¨å¤©çš„å¹´ä¼š
        </div>
      </div>
      <div class="sidebar-chat-input">
        <input type="text" 
               class="ai-chat-input" 
               placeholder="é—®æˆ‘å…³äºæ—¥ç¨‹å®‰æ’çš„é—®é¢˜..."
               id="chatInput">
        <button class="ai-chat-button" id="chatButton">å‘é€</button>
      </div>
    </div>
  </div>

  <!-- ä¸­é—´ä¸»å†…å®¹ -->
  <div class="main-content">
    <!-- å¤´éƒ¨åŒºåŸŸï¼ˆâ€œTodayâ€æŒ‰é’®ã€æœˆä»½æ˜¾ç¤ºã€å‰ååˆ‡æ¢ç­‰ï¼‰ -->
    <div class="main-header">
      <button id="todayBtn">Today</button>
      <div class="left-section">
        <button id="prevMonthBtn">&#10094;</button>
        <button id="nextMonthBtn">&#10095;</button>
        <h1 id="monthTitle">February 2025</h1>
      </div>
    </div>

    <!-- æ·»åŠ æ—¥å†å®¹å™¨ -->
    <div class="calendar-container">
      <div class="calendar" id="calendarHeader">
        <div class="weekday-header">Sunday</div>
        <div class="weekday-header">Monday</div>
        <div class="weekday-header">Tuesday</div>
        <div class="weekday-header">Wednesday</div>
        <div class="weekday-header">Thursday</div>
        <div class="weekday-header">Friday</div>
        <div class="weekday-header">Saturday</div>
      </div>
      <div class="calendar" id="calendarGrid">
        <!-- JS åŠ¨æ€å¡«å……æ—¥æœŸ -->
      </div>
    </div>
  </div>

  <!-- å³ä¾§æ ï¼šæ˜¾ç¤ºæŸä¸€å¤©çš„è¯¦ç»†ä¿¡æ¯ -->
  <div class="right-sidebar">
    <div class="date-info">
      <h2 id="selectedDateTitle">Sat, Feb 1</h2>
      <p id="selectedDateSub">Nothing planned for the day</p>
    </div>
    <div class="event-info">
      <p class="no-event">Enjoy!</p>
    </div>
  </div>

  <!-- è°ƒè¯•çª—å£ -->
  <div class="debug-window" id="debugWindow">
    <div class="close-btn" onclick="toggleDebugWindow()">Ã—</div>
    <pre id="debugContent"></pre>
  </div>

  <script>
    // --------------------- ç¤ºä¾‹ï¼šé™æ€æ˜¾ç¤º 2025å¹´2æœˆ ---------------------
    // å¦‚æœéœ€è¦åŠ¨æ€åˆ‡æ¢æœˆä»½ï¼Œå¯ä»¥åœ¨è¿™é‡Œè‡ªè¡Œæ‰©å±•

    // å›ºå®šè®¾ç½®è¦æ˜¾ç¤ºçš„æœˆä»½ä¸º 2025å¹´2æœˆ
    let displayYear = 2025;
    let displayMonth = 1; // JSä¸­ï¼š0=ä¸€æœˆï¼Œ1=äºŒæœˆï¼Œ2=ä¸‰æœˆ...

    const calendarGrid = document.getElementById("calendarGrid");
    const monthTitle = document.getElementById("monthTitle");
    const selectedDateTitle = document.getElementById("selectedDateTitle");
    const selectedDateSub = document.getElementById("selectedDateSub");

    // å…¨å±€å­˜å‚¨äº‹ä»¶æ•°æ®ï¼Œæ ¼å¼ï¼š{ "YYYY-MM-DD": [event1, event2, ...] }
    let events = {};
    let currentSelectedDate = null;

    // åˆå§‹åŒ–æ—¶æ¸²æŸ“
    renderCalendar(displayYear, displayMonth);

    // â€œTodayâ€æŒ‰é’®ã€å‰åæœˆä»½æŒ‰é’®ï¼Œä»…ä½œç¤ºä¾‹æ¼”ç¤º
    document.getElementById("todayBtn").addEventListener("click", () => {
      const today = new Date();
      displayYear = today.getFullYear();
      displayMonth = today.getMonth();
      renderCalendar(displayYear, displayMonth);
      fetchEventsForMonth(displayYear, displayMonth);
    });
    document.getElementById("prevMonthBtn").addEventListener("click", () => {
      displayMonth--;
      if (displayMonth < 0) {
        displayMonth = 11;
        displayYear--;
      }
      renderCalendar(displayYear, displayMonth);
      fetchEventsForMonth(displayYear, displayMonth);
    });
    document.getElementById("nextMonthBtn").addEventListener("click", () => {
      displayMonth++;
      if (displayMonth > 11) {
        displayMonth = 0;
        displayYear++;
      }
      renderCalendar(displayYear, displayMonth);
      fetchEventsForMonth(displayYear, displayMonth);
    });

    /**
     * æ¸²æŸ“æ—¥å†ä¸»å‡½æ•°
     * @param {number} year
     * @param {number} month (0-11)
     */
    function renderCalendar(year, month) {
      // æ›´æ–°æ ‡é¢˜ï¼ˆè‹±æ–‡æœˆä»½åç§°ï¼Œå¯è‡ªè¡Œæ”¹ä¸ºä¸­æ–‡ç­‰ï¼‰
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      monthTitle.textContent = `${monthNames[month]} ${year}`;

      // æ¸…ç©ºä¹‹å‰çš„æ—¥æœŸæ ¼å­
      calendarGrid.innerHTML = "";

      // å½“æœˆç¬¬ä¸€å¤©ä¸æœ€åä¸€å¤©
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      // éœ€è¦è¡¥è¶³å‰é¢ä¸åœ¨æœ¬æœˆçš„æ—¥æœŸï¼ˆfirstDay.getDay()è¿”å›å‘¨å‡ ï¼‰
      const startWeekday = firstDay.getDay(); // 0=å‘¨æ—¥,1=å‘¨ä¸€...
      // ä¸Šä¸ªæœˆæœ€åä¸€å¤©æ˜¯
      const lastDayOfPrevMonth = new Date(year, month, 0).getDate();

      // å°†æœ¬æœˆæ—¥æœŸæ”¾å…¥æ•°ç»„
      let daysArray = [];

      // å…ˆæ”¾ç½®å‰é¢ä¸å±äºæœ¬æœˆçš„æ—¥æœŸ
      for (let i = 0; i < startWeekday; i++) {
        daysArray.unshift({
          dayNum: lastDayOfPrevMonth - i,
          currentMonth: false
        });
      }
      // æ”¾ç½®å½“æœˆçš„æ‰€æœ‰æ—¥æœŸ
      for (let d = 1; d <= lastDay.getDate(); d++) {
        daysArray.push({
          dayNum: d,
          currentMonth: true
        });
      }

      // å¦‚æœå‰©ä½™æ ¼å­ä¸è¶³42ä¸ªï¼ˆ6å‘¨ï¼‰åˆ™ç»§ç»­å¡«å……åˆ°ä¸‹ä¸ªæœˆçš„æ—¥æœŸ
      while (daysArray.length < 42) {
        daysArray.push({
          dayNum: daysArray.length - (startWeekday + lastDay.getDate()) + 1,
          currentMonth: false
        });
      }

      // å°† 42 ä¸ªæ—¥æœŸä»¥ 7 å¤©ä¸ºä¸€è¡Œæ˜¾ç¤º
      daysArray.forEach((item, index) => {
        const dayCell = document.createElement("div");
        dayCell.className = "day-cell";

        const dayNumber = document.createElement("div");
        dayNumber.className = "day-number";
        if (!item.currentMonth) {
          dayNumber.classList.add("not-current-month");
        }
        dayNumber.textContent = item.dayNum;
        dayCell.appendChild(dayNumber);

        // æ ¹æ®å•å…ƒæ ¼æ•°æ®ç¡®å®šå®é™…æ—¥æœŸï¼ˆå¯¹äºéæœ¬æœˆæ—¥æœŸï¼Œç®€å•æŒ‰ dayNum åˆ¤å®šå‰åæœˆä»½ï¼‰
        const cellMonth = item.currentMonth ? month : (item.dayNum < 15 ? month + 1 : month - 1);
        const cellDate = new Date(year, cellMonth, item.dayNum);
        const cellDateKey = cellDate.toISOString().slice(0, 10);

        // å¦‚æœè¯¥å¤©å­˜åœ¨äº‹ä»¶ï¼Œåˆ™åœ¨å•å…ƒæ ¼ä¸­æ·»åŠ äº‹ä»¶æç¤º
        if (events[cellDateKey] && events[cellDateKey].length > 0) {
          const markersDiv = document.createElement("div");
          markersDiv.className = "event-markers";
          // æ˜¾ç¤ºæœ€å¤š 2 æ¡äº‹ä»¶
          events[cellDateKey].slice(0, 2).forEach(ev => {
            const marker = document.createElement("div");
            marker.className = "event-marker";
            marker.textContent = "ğŸ”· " + ev.title;
            markersDiv.appendChild(marker);
          });
          // è‹¥æœ‰è¶…è¿‡ 2 æ¡äº‹ä»¶ï¼Œåˆ™æ˜¾ç¤ºâ€œ+X æ›´å¤šâ€
          if (events[cellDateKey].length > 2) {
            const moreMarker = document.createElement("div");
            moreMarker.className = "event-marker";
            moreMarker.textContent = "+" + (events[cellDateKey].length - 2) + " æ›´å¤š";
            markersDiv.appendChild(moreMarker);
          }
          dayCell.appendChild(markersDiv);
        }

        // ç‚¹å‡»æ—¶åœ¨å³ä¾§æ˜¾ç¤ºâ€œSat, Feb 1â€ç­‰ä¿¡æ¯ï¼Œå¹¶åŠ è½½è¯¥å¤©äº‹ä»¶
        dayCell.addEventListener("click", () => {
          updateRightSidebar(cellDate);
        });

        calendarGrid.appendChild(dayCell);
      });
    }

    /**
     * Fetch events for the displayed month from FastAPI API
     */
    function fetchEventsForMonth(year, month) {
      const apiUrl = `/api/events?year=${year}&month=${month+1}`;  // ä¿®æ”¹ä¸ºFastAPIæœåŠ¡å™¨åœ°å€
      
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          // å°†è¿”å›çš„æ•°æ®ç»„ç»‡ä¸º { "YYYY-MM-DD": [event, ...] }
          events = {};
          data.forEach(event => {
            const dateKey = event.date; // æ ¼å¼ï¼šYYYY-MM-DD
            if (!events[dateKey]) {
              events[dateKey] = [];
            }
            events[dateKey].push(event);
          });
          
          // é‡æ–°æ¸²æŸ“æ—¥å†ï¼Œä»¥æ˜¾ç¤ºäº‹ä»¶æç¤º
          renderCalendar(displayYear, displayMonth);
          
          // å¦‚æœå·²æœ‰é€‰ä¸­çš„æ—¥æœŸï¼Œåˆ™æ›´æ–°å³ä¾§è¯¦æƒ…
          if (currentSelectedDate) {
            fetchEventsForDate(currentSelectedDate);
          }
        })
        .catch(error => {
          console.error('Error fetching events:', error);
        });
    }

    /**
     * Fetch events for a specific date
     */
    function fetchEventsForDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const dateString = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
      
      const apiUrl = `/api/events?date=${dateString}`;  // ä¿®æ”¹ä¸ºFastAPIæœåŠ¡å™¨åœ°å€
      
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          displayEventsInSidebar(data, date);
        })
        .catch(error => {
          console.error('Error fetching events for date:', error);
          selectedDateSub.textContent = `Year: ${year}. Error loading events.`;
        });
    }

    /**
     * Display events in the right sidebar
     */
    function displayEventsInSidebar(eventsData, date) {
      const eventInfo = document.querySelector('.event-info');
      eventInfo.innerHTML = '';
      
      const year = date.getFullYear();
      
      if (eventsData.length === 0) {
        selectedDateSub.textContent = `Year: ${year}. Nothing planned for the day.`;
        const noEvent = document.createElement('p');
        noEvent.className = 'no-event';
        noEvent.textContent = 'Enjoy!';
        eventInfo.appendChild(noEvent);
        return;
      }
      
      selectedDateSub.textContent = `Year: ${year}. ${eventsData.length} event(s) planned.`;
      
      eventsData.forEach(event => {
        const eventElement = document.createElement('div');
        eventElement.className = 'event-item';
        eventElement.style.marginBottom = '15px';
        eventElement.style.padding = '10px';
        eventElement.style.backgroundColor = '#3a3a3a';
        eventElement.style.borderRadius = '4px';
        
        const eventTitle = document.createElement('h3');
        eventTitle.style.fontSize = '16px';
        eventTitle.style.marginBottom = '5px';
        eventTitle.textContent = event.title;
        
        const eventTime = document.createElement('p');
        eventTime.style.fontSize = '14px';
        eventTime.style.color = '#bbb';
        eventTime.textContent = `${event.time_start || '00:00'} - ${event.time_end || '23:59'}`;
        
        const eventDescription = document.createElement('p');
        eventDescription.style.fontSize = '14px';
        eventDescription.style.marginTop = '5px';
        eventDescription.textContent = event.description || 'No description';
        
        eventElement.appendChild(eventTitle);
        eventElement.appendChild(eventTime);
        eventElement.appendChild(eventDescription);
        eventInfo.appendChild(eventElement);
      });
    }

    /**
     * Update the right sidebar content and fetch events
     */
    function updateRightSidebar(date) {
      const weekdayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      const monthNames = [
        "Jan", "Feb", "Mar", "Apr", "May", "Jun",
        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
      ];
      const weekDay = weekdayNames[date.getDay()];
      const monthName = monthNames[date.getMonth()];
      const day = date.getDate();
      const year = date.getFullYear();

      // ä¾‹å¦‚ï¼šSat, Feb 1
      selectedDateTitle.textContent = `${weekDay}, ${monthName} ${day}`;
      currentSelectedDate = date;
      
      // æ˜¾ç¤ºåŠ è½½ä¿¡æ¯
      selectedDateSub.textContent = `Year: ${year}. Loading events...`;
      
      // Fetch events for this date
      fetchEventsForDate(date);
    }

    // æ·»åŠ AIå¯¹è¯åŠŸèƒ½
    document.getElementById('chatButton').addEventListener('click', handleAiChat);
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleAiChat();
        }
    });

    function handleAiChat() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (message) {
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, true);

            fetch('/chat', {  // ä¿®æ”¹ä¸ºFastAPIæœåŠ¡å™¨åœ°å€
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                // æ·»åŠ AIå“åº”
                addMessage(data.response, false);
                
                // å¦‚æœåˆ›å»ºäº†æ–°äº‹ä»¶ï¼Œåˆ·æ–°æ—¥å†æ˜¾ç¤º
                if (data.event) {
                    fetchEventsForMonth(displayYear, displayMonth);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºé”™äº†', false);
            });

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
        }
    }

    function addMessage(text, isUser) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
        messageElement.innerHTML = text.replace(/\n/g, '<br>');
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // æ·»åŠ è°ƒè¯•çª—å£åˆ‡æ¢åŠŸèƒ½
    function toggleDebugWindow() {
        const debugWindow = document.getElementById('debugWindow');
        debugWindow.classList.toggle('show');
    }

    // Initial fetch for events when calendar is first rendered
    fetchEventsForMonth(displayYear, displayMonth);
  </script>
</body>
</html>
